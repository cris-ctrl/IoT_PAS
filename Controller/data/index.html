<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP Controller</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, sans-serif;
    }
    
    body {
      background-color: #1e2a38;
      color: #e0e7ff;
      min-height: 100vh;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .container {
      width: 100%;
      max-width: 500px;
    }
    
    header {
      text-align: center;
      padding: 20px 15px;
      margin-bottom: 15px;
      background-color: #2a3a4d;
      border-radius: 12px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    }
    
    h1 {
      font-size: 1.8rem;
      margin-bottom: 5px;
      color: #5d9bff;
    }
    
    .subtitle {
      font-size: 0.95rem;
      opacity: 0.85;
      margin-top: 5px;
    }
    
    .dashboard {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .device-card {
      background-color: #2a3a4d;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    }
    
    .device-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #3a4a5d;
    }
    
    .device-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #3a4a5d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    
    .device-name {
      font-size: 1.4rem;
      font-weight: 600;
      color: #6aa6ff;
    }
    
    .device-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: #4caf50;
    }
    
    .status-offline {
      background-color: #f44336;
    }
    
    .status-stale {
      background-color: #ff9800;
    }
    
    .status-text {
      font-weight: 500;
    }
    
    .controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 10px;
    }
    
    .toggle-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 15px;
      background-color: #3a4a5d;
      border-radius: 10px;
    }
    
    .toggle-label {
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #6a7a8d;
      transition: .4s;
      border-radius: 28px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: #4caf50;
    }
    
    input:checked + .slider:before {
      transform: translateX(22px);
    }
    
    .connection-info {
      background-color: #2a3a4d;
      border-radius: 12px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    }
    
    .info-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .info-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background-color: #3a4a5d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      color: #6aa6ff;
    }
    
    .info-text {
      flex-grow: 1;
      font-size: 1rem;
    }
    
    .info-value {
      font-weight: 500;
      color: #6aa6ff;
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 15px;
      background-color: #3a4a5d;
      border-radius: 10px;
      font-size: 1rem;
    }
    
    .connection-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background-color: #4caf50;
    }
    
    .connection-partial {
      background-color: #ff9800;
    }
    
    .connection-offline {
      background-color: #f44336;
    }
    
    footer {
      margin-top: 25px;
      text-align: center;
      font-size: 0.85rem;
      opacity: 0.7;
      padding: 15px;
    }
    
    /* Status colors */
    .device-online .status-text {
      color: #4caf50;
    }
    
    .device-offline .status-text {
      color: #f44336;
    }
    
    .device-stale .status-text {
      color: #ff9800;
    }
    
    /* Responsive adjustments */
    @media (max-width: 400px) {
      .device-card, .connection-info {
        padding: 15px;
      }
      
      .device-name {
        font-size: 1.3rem;
      }
      
      .toggle-label {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ESP Controller</h1>
      <p class="subtitle">Monitor and control your IoT devices</p>
    </header>
    
    <div class="dashboard">
      <!-- Device 2C -->
      <div class="device-card">
        <div class="device-header">
          <div class="device-icon">
            <i class="fas fa-microchip"></i>
          </div>
          <div class="device-name">LED 2C</div>
        </div>
        
        <div class="device-status">
          <div class="status-indicator" id="indicator2C"></div>
          <div class="status-text" id="status2C">Online</div>
        </div>
        
        <div class="controls">
          <div class="toggle-container">
            <div class="toggle-label">Toggle State</div>
            <label class="toggle-switch">
              <input type="checkbox" id="toggle2C" onchange="toggle('2C', this.checked)">
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
      
      <!-- Device A4 -->
      <div class="device-card">
        <div class="device-header">
          <div class="device-icon">
            <i class="fas fa-microchip"></i>
          </div>
          <div class="device-name">LED A4</div>
        </div>
        
        <div class="device-status">
          <div class="status-indicator" id="indicatorA4"></div>
          <div class="status-text" id="statusA4">Online</div>
        </div>
        
        <div class="controls">
          <div class="toggle-container">
            <div class="toggle-label">Toggle State</div>
            <label class="toggle-switch">
              <input type="checkbox" id="toggleA4" onchange="toggle('A4', this.checked)">
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
    </div>
    
    <div class="connection-info">
      <div class="info-row">
        <div class="info-icon">
          <i class="fas fa-network-wired"></i>
        </div>
        <div class="info-text">Controller IP:</div>
        <div class="info-value" id="controllerIp">192.168.1.100</div>
      </div>
      
      <div class="connection-status">
        <div class="connection-dot" id="globalDot"></div>
        <span id="globalStatus">Connected to all devices</span>
      </div>
    </div>
    
    <footer>
      <p>ESP Controller Dashboard v1.2</p>
    </footer>
  </div>

  <script>
    // Device states
    const devices = {
      'A4': { 
        status: document.getElementById('statusA4'),
        indicator: document.getElementById('indicatorA4'),
        toggle: document.getElementById('toggleA4'),
        lastAck: 0,
        stale: false
      },
      '2C': { 
        status: document.getElementById('status2C'),
        indicator: document.getElementById('indicator2C'),
        toggle: document.getElementById('toggle2C'),
        lastAck: 0,
        stale: false
      }
    };
    
    // Connection status
    let connectionStatus = {
      allOnline: true,
      partial: false
    };
    
    function checkStatus() {
      fetch('/status')
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.json();
        })
        .then(data => {
          // Update device statuses
          updateDevice('A4', data.A4);
          updateDevice('2C', data['2C']);
          
          // Update global connection status
          updateGlobalStatus();
          
          // Schedule next check
          setTimeout(checkStatus, 1000);
        })
        .catch(error => {
          console.error('Status check failed:', error);
          setAllOffline();
          setTimeout(checkStatus, 2000);
        });
    }
    
    function updateDevice(deviceId, timeDiff) {
      const device = devices[deviceId];
      const seconds = Math.floor(timeDiff / 1000);
      
      // Update status based on time difference
      if (timeDiff < 5000) { // Less than 5 seconds
        device.status.textContent = "Online";
        device.status.parentElement.classList.remove('device-offline', 'device-stale');
        device.status.parentElement.classList.add('device-online');
        device.indicator.className = "status-indicator";
        device.stale = false;
      } 
      else if (timeDiff < 10000) { // 5-10 seconds
        device.status.textContent = "Stale";
        device.status.parentElement.classList.remove('device-online', 'device-offline');
        device.status.parentElement.classList.add('device-stale');
        device.indicator.className = "status-indicator status-stale";
        device.stale = false;
      } 
      else { // More than 10 seconds
        device.status.textContent = "Offline";
        device.status.parentElement.classList.remove('device-online', 'device-stale');
        device.status.parentElement.classList.add('device-offline');
        device.indicator.className = "status-indicator status-offline";
        device.stale = true;
      }
    }
    
    function updateGlobalStatus() {
      const offlineDevices = Object.values(devices).filter(d => d.stale).length;
      const totalDevices = Object.keys(devices).length;
      
      const globalDot = document.getElementById('globalDot');
      const globalStatus = document.getElementById('globalStatus');
      
      if (offlineDevices === 0) {
        globalStatus.textContent = "Connected to all devices";
        globalStatus.className = "";
        globalDot.className = "connection-dot";
        connectionStatus.partial = false;
        connectionStatus.allOnline = true;
      } 
      else if (offlineDevices === totalDevices) {
        globalStatus.textContent = "All devices offline";
        globalStatus.className = "";
        globalDot.className = "connection-dot connection-offline";
        connectionStatus.partial = false;
        connectionStatus.allOnline = false;
      } 
      else {
        globalStatus.textContent = `Partial connection (${offlineDevices} offline)`;
        globalStatus.className = "";
        globalDot.className = "connection-dot connection-partial";
        connectionStatus.partial = true;
        connectionStatus.allOnline = false;
      }
    }
    
    function setAllOffline() {
      for (const deviceId in devices) {
        const device = devices[deviceId];
        device.status.textContent = "Offline";
        device.status.parentElement.classList.remove('device-online', 'device-stale');
        device.status.parentElement.classList.add('device-offline');
        device.indicator.className = "status-indicator status-offline";
      }
      
      document.getElementById('globalStatus').textContent = "Connection lost";
      document.getElementById('globalDot').className = "connection-dot connection-offline";
    }
    
    function toggle(target, state) {
      // Send command to ESP
      fetch(`/toggle?target=${target}&state=${state ? 1 : 0}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Toggle command failed');
          }
        })
        .catch(error => {
          console.error('Toggle failed:', error);
          // Revert UI if failed
          devices[target].toggle.checked = !state;
        });
    }
    
    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', function() {
      // Set controller IP
      const url = new URL(window.location.href);
      document.getElementById('controllerIp').textContent = url.hostname;
      
      // Start status checks
      checkStatus();
    });
  </script>
  
  <!-- Font Awesome for icons -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
</body>
</html>